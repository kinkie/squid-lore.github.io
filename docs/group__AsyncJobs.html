<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Squid Web Cache: Asynchronous Jobs</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Squid Web Cache<span id="projectnumber">&#160;v8/master</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('group__AsyncJobs.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">Asynchronous Jobs<div class="ingroups"><a class="el" href="group__Components.html">Squid Components</a></div></div></div>
</div><!--header-->
<div class="contents">
<div class="dynheader">
Collaboration diagram for Asynchronous Jobs:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="group__AsyncJobs.svg" width="347" height="36"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<h1><a class="anchor" id="AsyncJobsTerminology"></a>
Terminology</h1>
<ul>
<li><b>Job:</b> an <a class="el" href="classAsyncJob.html">AsyncJob</a> object.</li>
<li><b>Creator:</b> the code creating the job. Usually the Initiator.</li>
<li><b>Start:</b> the act of calling <a class="el" href="classAsyncJob.html#a1dd42e9842d751193268966d4e0de2fa">AsyncJob::Start</a> with a job pointer.</li>
<li><b>Initiator:</b> the code starting the job. Usually the Creator.</li>
</ul>
<h1><a class="anchor" id="AsyncJobsLifecycle"></a>
Typical life cycle</h1>
<ol type="1">
<li>Creator creates and initializes a job.</li>
<li>If Initiator expects to communicate with the job after start, then it stores the job pointer</li>
<li>Initiator starts the job by calling <a class="el" href="classAsyncJob.html#a1dd42e9842d751193268966d4e0de2fa">AsyncJob::Start</a>.</li>
<li>The job's start() method is called. The method usually schedules some I/O or registers to receive some other callbacks.</li>
<li>The job runs and does what it is supposed to do. This usually involves scheduling I/O, setting timeouts, receiving <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> or <a class="el" href="namespaceStore.html">Store</a> callbacks, and then notifying Initiator of the final result.</li>
<li>The job reaches its goal or encounters an error condition.</li>
<li>The swanSong() method is called.</li>
<li>The job object is destroyed.</li>
</ol>
<p>If you want to do something before starting the job, do it in the constructor or some custom method that the job creator will call <em>before</em> calling <a class="el" href="classAsyncJob.html#a1dd42e9842d751193268966d4e0de2fa">AsyncJob::Start()</a>: </p><pre class="fragment">std::unique_ptr&lt;MyJob&gt; job(new MyJob(...)); // sync/blocking
job-&gt;prepare(...); // sync/blocking
job-&gt;prepareSomethingElse(...); // sync/blocking
AsyncStart(job.release()); // non-blocking
</pre><p> If you do not need complex preparations, it is better to do this instead: </p><pre class="fragment">AsyncJob::Start(new MyJob(...));
</pre><p> Keep in mind that you have no async debugging, cleanup, and protections until you call <a class="el" href="classAsyncJob.html#a1dd42e9842d751193268966d4e0de2fa">AsyncJob::Start</a> with a job pointer.</p>
<h1><a class="anchor" id="AsyncJobsBasicRules"></a>
Basic rules</h1>
<ul>
<li>To start a job, use <a class="el" href="classAsyncJob.html#a1dd42e9842d751193268966d4e0de2fa">AsyncJob::Start</a>. Do not start the same job more than once.</li>
<li>Never call start() directly. Treat this method as <a class="el" href="kerberos__ldap__group_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a> in C/C++.</li>
<li>Never call swanSong() directly. If you are outside an <a class="el" href="classAsyncCall.html">AsyncCall</a> handler, and want to kill the job, then call deleteThis(). If you are inside an <a class="el" href="classAsyncCall.html">AsyncCall</a> handler, you have several options for job termination:<ol type="1">
<li>Call mustStop(reason) for errors that require further processing in the same method(s) chain, below/after the mustStop() call. Efficient.</li>
<li>Throw (via Must or directly) for errors that do not require further processing in the same method(s) chain, below/after the mustStop() call. Inefficient but simple and allows exiting from deeply nested method calls.</li>
<li>Otherwise, just finish the call. Your doneAll() should return true and the job will terminate successfully.</li>
</ol>
</li>
</ul>
<p>swanSong() will be called automatically in all of these cases when the job is being terminated. It is a general cleanup method, like a destructor. The only difference is that a destructor must not throw.</p>
<ul>
<li>Do not assume swanSong() is called in some perfectly nice job state. The job code or the code it calls may throw at any time after start() was called. The entry may be gone, the Abort may have been called, the fd may have been closed, etc.</li>
<li>Never call deleteThis() in contexts other than those documented above. It is a hack for the old-style code. You can avoid it and other old-style special precautions altogether if you convert sync calls into async ones. This is especially easy for old-style calls that have only one parameter ("data") or two simple parameters.</li>
<li>In swanSong, always call swanSong() of the parent, after you are done cleaning up your job. It does not matter whether the [current] parent swanSong() does nothing.</li>
<li>You must implement start() and doneAll() methods. These methods may be marked as pure virtual in future releases.</li>
<li>In doneAll(), always call doneAll() of the parent. If the parent is not done, you are not done. It does not matter whether the [current] parent doneAll() always returns true.</li>
<li>If a job does not have a doneAll() method implemented, it is probably buggy. Any job must know what it wants to accomplish. Please note that doneAll() is for defining the successful termination goal/condition. Errors are handled by mustStop() or throw, as discussed above.</li>
</ul>
<p>Similarly, if your doneAll() implementation looks like "return isDone;", you are doing it wrong. Compute the condition directly rather than expecting various job methods to maintain some isDone variable correctly.</p>
<ul>
<li>If a job does <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> I/O, it probably needs a <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> closing handler.</li>
<li>If a job stores a <a class="el" href="classStoreEntry.html">StoreEntry</a>, it probably needs an entry Abort handler.</li>
<li>Ask yourself what the user will see/experience when the job throws, which could happen as early as in the start() method (technically, it can happen even earlier, during job creation and initialization). Are you OK with that? </li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
