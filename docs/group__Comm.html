<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Squid Web Cache: Comm Module</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Squid Web Cache<span id="projectnumber">&#160;v8/master</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('group__Comm.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">Comm Module<div class="ingroups"><a class="el" href="group__Components.html">Squid Components</a></div></div></div>
</div><!--header-->
<div class="contents">
<div class="dynheader">
Collaboration diagram for Comm Module:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="group__Comm.svg" width="320" height="36"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<h1><a class="anchor" id="Basic"></a>
Basic Comm API principles</h1>
<dl class="section user"><dt></dt><dd><a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> API supports four major kinds of socket-related operations: accept, connect, read, and write. Sockets are identified by their descriptors.</dd></dl>
<dl class="section user"><dt></dt><dd>A <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> user requests its interest in operations by calling an appropriate API function (e.g., <a class="el" href="Read_8h.html#a172f652cee9cf7837348c4a3bb6599f7">comm_read()</a>) and optionally providing a notification "callback" (a.k.a., handler). For a given descriptor, there can be no more than one registered user per operation.</dd></dl>
<dl class="section user"><dt></dt><dd>In addition to the four operations listed above, a user can register to be notified when a given descriptor is closed.</dd></dl>
<dl class="section user"><dt></dt><dd>When a <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> operation completes, all users that registered the corresponding handler are notified. When a descriptor is closed, all users that registered any callback for the descriptor are notified (this will change though, see "Anticipated changes" below).</dd></dl>
<dl class="section user"><dt></dt><dd>All <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> notifications are asynchronous, performed using the <a class="el" href="classAsyncCall.html">AsyncCall</a> API.</dd></dl>
<dl class="section user"><dt></dt><dd>Notifications for four operations listed above are scheduled in the order of the corresponding operations completion. User code can assume that the operation has completed (possibly with an error) only after receiving a notification. Until then, I/O resources such as buffers must remain available for the operation.</dd></dl>
<dl class="section user"><dt></dt><dd>Notifications related to closing of a descriptor are documented separately.</dd></dl>
<h1><a class="anchor" id="IO-cancel"></a>
I/O cancellation</h1>
<dl class="section user"><dt></dt><dd>To cancel an interest in a read operation, call <a class="el" href="Read_8cc.html#aeb52e12cf4be753f4ae38ee1cf54d82c">comm_read_cancel()</a> with an <a class="el" href="classAsyncCall.html">AsyncCall</a> object. This call guarantees that the passed Call will be canceled (see the <a class="el" href="classAsyncCall.html">AsyncCall</a> API for call cancellation definitions and details). Naturally, the code has to store the original read callback Call pointer to use this interface.</dd></dl>
<dl class="section user"><dt></dt><dd>The <a class="el" href="Read_8cc.html#aeb52e12cf4be753f4ae38ee1cf54d82c">comm_read_cancel()</a> call does not guarantee that the read operation has not already happen.</dd></dl>
<dl class="section user"><dt></dt><dd>The <a class="el" href="Read_8cc.html#aeb52e12cf4be753f4ae38ee1cf54d82c">comm_read_cancel()</a> call guarantees that the read operation will not start for read operations that are performed by <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> (i.e., where read start is controlled by <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a>). There is no such guarantee for asynchronous read operations scheduled by <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> but started by the operating system or other threads.</dd></dl>
<dl class="section user"><dt></dt><dd>The above applies to <a class="el" href="Read_8cc.html#aeb52e12cf4be753f4ae38ee1cf54d82c">comm_read_cancel()</a> interface with an <a class="el" href="classAsyncCall.html">AsyncCall</a> object as a parameter. You cannot reliably cancel an interest in read operation using the old <a class="el" href="Read_8cc.html#aeb52e12cf4be753f4ae38ee1cf54d82c">comm_read_cancel()</a> call that uses a function pointer. The handler may get even called after old <a class="el" href="Read_8cc.html#aeb52e12cf4be753f4ae38ee1cf54d82c">comm_read_cancel()</a> was called.</dd></dl>
<dl class="section user"><dt></dt><dd>It is OK to call comm_read_cancel (both flavors) at any time as long as the descriptor has not been closed and there is either no read interest registered or the passed parameters match the registered ones. If the descriptor has been closed, the behavior is undefined. Otherwise, if parameters do not match, you get an assertion.</dd></dl>
<dl class="section user"><dt></dt><dd>To cancel <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> operations other than read, close the descriptor with <a class="el" href="comm_8h.html#ab045769a55e89a7281c201b121e5fc42">comm_close()</a>.</dd></dl>
<h1><a class="anchor" id="comm-close"></a>
Descriptor closing with comm_close</h1>
<dl class="section user"><dt></dt><dd>The <a class="el" href="comm_8h.html#ab045769a55e89a7281c201b121e5fc42">comm_close()</a> function does not close the descriptor but initiates the following closing sequence:</dd></dl>
<dl class="section user"><dt></dt><dd><ol type="1">
<li>The descriptor is placed in a "closing" state.</li>
<li>The registered read, write, and accept callbacks (if any) are scheduled (in an unspecified order).</li>
<li>The close callbacks are scheduled (in an unspecified order).</li>
<li>A call to the internal descriptor closing handler is scheduled.</li>
</ol>
</dd></dl>
<dl class="section user"><dt></dt><dd>The "unspecified" order above means that the user should not rely on any specific or deterministic order because the currently hard-coded order may change.</dd></dl>
<dl class="section user"><dt></dt><dd>The read, write, and accept notifications (scheduled in step #2 above) carry the <a class="el" href="namespaceComm.html#a9d8d4f4a5745b975c5785998e4246050a884f9d58f0f131131497fa9ceefb3b3c">Comm::ERR_CLOSING</a> error flag. When handling <a class="el" href="namespaceComm.html#a9d8d4f4a5745b975c5785998e4246050a884f9d58f0f131131497fa9ceefb3b3c">Comm::ERR_CLOSING</a> event, the user code should limit descriptor-related processing, especially <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> calls, because supported <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> functionality is very limited when the descriptor is closing. New code should use the close handlers instead (scheduled in step #3).</dd></dl>
<dl class="section user"><dt></dt><dd>The internal closing handler (scheduled in step #4 above) closes the descriptor. When the descriptor is closed, all operations on the descriptor are prohibited and may cause bugs and asserts. Currently, the same descriptor will eventually be reused for another socket and <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> may not notice that a buggy code is still using a stale descriptor, but that may change.</dd></dl>
<dl class="section user"><dt></dt><dd>Since all notifications are asynchronous, it is possible for a read or write notification that was scheduled before <a class="el" href="comm_8h.html#ab045769a55e89a7281c201b121e5fc42">comm_close()</a> was called to arrive at its destination after <a class="el" href="comm_8h.html#ab045769a55e89a7281c201b121e5fc42">comm_close()</a> was called. Such notification will arrive with <a class="el" href="namespaceComm.html#a9d8d4f4a5745b975c5785998e4246050a884f9d58f0f131131497fa9ceefb3b3c">Comm::ERR_CLOSING</a> flag even though that flag was not set at the time of the I/O (and the I/O may have been successful). This behavior may change.</dd></dl>
<h1><a class="anchor" id="Future"></a>
Anticipated changes and preparation recommendations</h1>
<dl class="section user"><dt></dt><dd>This section lists anticipated <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> API changes and provides recommendations for developers writing new (or rewriting old) <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> user code. The changes are listed in a rough order from more likely to less certain and from near-feature to long-term.</dd></dl>
<dl class="section user"><dt></dt><dd>The old <a class="el" href="Read_8cc.html#aeb52e12cf4be753f4ae38ee1cf54d82c">comm_read_cancel()</a> function that uses a function pointer will be removed as unreliable. Use the AsyncCall-based <a class="el" href="Read_8cc.html#aeb52e12cf4be753f4ae38ee1cf54d82c">comm_read_cancel()</a> instead.</dd></dl>
<dl class="section user"><dt></dt><dd><a class="el" href="namespaceComm.html#a9d8d4f4a5745b975c5785998e4246050a884f9d58f0f131131497fa9ceefb3b3c">Comm::ERR_CLOSING</a> interface will be removed. The read, write, and accept notifications will not be scheduled after <a class="el" href="comm_8h.html#ab045769a55e89a7281c201b121e5fc42">comm_close()</a> is called. New user code should register close handlers instead.</dd></dl>
<dl class="section user"><dt></dt><dd>When <a class="el" href="namespaceComm.html#a9d8d4f4a5745b975c5785998e4246050a884f9d58f0f131131497fa9ceefb3b3c">Comm::ERR_CLOSING</a> interface is removed, pending notifications (if any) will be canceled after <a class="el" href="comm_8h.html#ab045769a55e89a7281c201b121e5fc42">comm_close()</a> is called. However, the cancellation may be removed later if <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> is modified to provide safe access to closing descriptors and their fragile state. New user code should continue to assume that it is safe to access <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> in a read, write, and accept handlers.</dd></dl>
<dl class="section user"><dt></dt><dd>The old <a class="el" href="Read_8cc.html#aeb52e12cf4be753f4ae38ee1cf54d82c">comm_read_cancel()</a> call that uses a function pointer will be removed as unreliable. New user code should use <a class="el" href="Read_8cc.html#aeb52e12cf4be753f4ae38ee1cf54d82c">comm_read_cancel()</a> with an <a class="el" href="classAsyncCall.html">AsyncCall</a> parameter.</dd></dl>
<dl class="section user"><dt></dt><dd><a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> users may be required to become children of Comm-provided classes, to eliminate the need for a complicated (albeit hidden) hierarchy of <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> callback dialers (see <a class="el" href="CommCalls_8h.html">CommCalls.h</a>) and to provide default implementation for common I/O handling cases. New user code should use methods of AsyncJob-derived classes to handle <a class="el" href="namespaceComm.html" title="Abstraction layer for TCP, UDP, TLS, UDS and filedescriptor sockets.">Comm</a> notifications instead of using stand-alone functions. Additionally, it should not call <a class="el" href="comm_8h.html#ab045769a55e89a7281c201b121e5fc42">comm_close()</a> for descriptors it does not "own".</dd></dl>
<dl class="section user"><dt></dt><dd>The <a class="el" href="comm_8h.html#ab045769a55e89a7281c201b121e5fc42">comm_close()</a> API will be used exclusively for "stop future I/O,
  schedule a close callback call, and cancel all other callbacks" purposes. New user code should not use <a class="el" href="comm_8h.html#ab045769a55e89a7281c201b121e5fc42">comm_close()</a> for the purpose of immediately ending a job.</dd></dl>
<dl class="section user"><dt></dt><dd><a class="el" href="classRaw.html">Raw</a> socket descriptors will be replaced with unique IDs or small objects that help detect stale descriptor/socket usage bugs and encapsulate access to socket-specific information. New user code should treat descriptor integers as opaque objects. </dd></dl>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
